<html>

<head>
  <title>Input Form</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.734.0.min.js"></script>
  <script src="https://unpkg.com/unfetch@4.1.0/dist/unfetch.umd.js"></script>
</head>

<body>
  <h1>Enter your information:</h1>
  <label>Universe:</label>
  <input type="text" id="universe"><br><br>
  <label>Character(s):</label>
  <input type="text" id="characters"><br><br>
  <label>Genre:</label>
  <input type="text" id="genre"><br><br>
  <button id="myButton">Submit</button>
  <script type="text/javascript">
    AWS.config.update({
      region: 'us-east-1'
    });
    async function submitForm() {
      console.log("Got here!")
      var universe = document.getElementById("universe").value;
      var characters = document.getElementById("characters").value;
      var genre = document.getElementById("genre").value;
      prompt = `Q: Please create a summary of a fanfiction from the ${universe} fictional universe with the characters ${characters} in the ${genre} genre. A:`;
      fanfic = await makeCompletionRequest(prompt);
      alert(fanfic);
      console.log(fanfic)
    }
    async function makeCompletionRequest(prompt) {
      console.log("Got to the request")
      const endpoint = 'https://api.openai.com/v1/engines/text-davinci-002/completions';
      const apiKey = await getSecretValue("openai-key");

      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          prompt: prompt,
          max_tokens: 100,
          n: 1,
          stop: '',
          temperature: 0.5
        })
      };

      try {
        const response = await fetch(endpoint, options);
        const json = await response.json();
        return json.choices[0].text;
      } catch (error) {
        console.error(error);
        return '';
      }
    }
    async function getSecretValue(secretName) {
      console.log("Got to the secret manager method")
      const AWS = window.AWS;
      const client = new AWS.SecretsManager();

      try {
        const response = await client.getSecretValue({
          SecretId: secretName
        }).promise();

        if ('SecretString' in response) {
          return response.SecretString;
        } else {
          let buff = new Buffer(response.SecretBinary, 'base64');
          return buff.toString('ascii');
        }
      } catch (err) {
        console.log("Error retrieving secret: " + err);
        throw err;
      }
    }

    document.getElementById('myButton').addEventListener('click', async () => {
      await submitForm();
    });
  </script>
</body>
</html>
